---
import { 
    Bold, 
    Italic, 
    Underline, 
    Strikethrough, 
    Code, 
    Feather, 
    Scroll, 
    Type, 
    Eraser, 
    Copy, 
    Trash2
} from 'lucide-astro';
---
<!-- Import Quill Styles -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />

<div class="editor-wrapper">
  <!-- Ribbon Toolbar -->
  <div id="toolbar" class="ribbon-toolbar">
    
    <!-- Standard Formatting Group -->
    <div class="ribbon-group">
        <span class="group-label" data-i18n="inlinked.format_group">Formato</span>
        <div class="group-content">
            <button class="format-btn ribbon-btn" data-format="bold" title="Negrita" data-i18n-tooltip="inlinked.bold">
                <div class="icon-box"><Bold class="icon" /></div>
                <span class="label" data-i18n="inlinked.bold">Negrita</span>
            </button>
            <button class="format-btn ribbon-btn" data-format="italic" title="Cursiva" data-i18n-tooltip="inlinked.italic">
                <div class="icon-box"><Italic class="icon" /></div>
                <span class="label" data-i18n="inlinked.italic">Cursiva</span>
            </button>
            <button class="format-btn ribbon-btn" data-format="underline" title="Subrayado" data-i18n-tooltip="inlinked.underline">
                <div class="icon-box"><Underline class="icon" /></div>
                <span class="label" data-i18n="inlinked.underline">Subr.</span>
            </button>
            <button class="format-btn ribbon-btn" data-format="strike" title="Tachado" data-i18n-tooltip="inlinked.strikethrough">
                <div class="icon-box"><Strikethrough class="icon" /></div>
                <span class="label" data-i18n="inlinked.strikethrough">Tachado</span>
            </button>
            <button class="format-btn ribbon-btn" data-format="code" title="Código" data-i18n-tooltip="inlinked.code">
                <div class="icon-box"><Code class="icon" /></div>
                <span class="label" data-i18n="inlinked.code">Código</span>
            </button>
        </div>
    </div>

    <!-- Separator -->
    <div class="separator"></div>

    <!-- Custom Fonts Group -->
    <div class="ribbon-group">
        <span class="group-label" data-i18n="inlinked.linkedin_group">Estilos LinkedIn</span>
        <div class="group-content">
            <button class="custom-btn ribbon-btn" data-variant="script" title="Script">
                <div class="icon-box"><Feather class="icon" /></div>
                <span class="label">Script</span>
            </button>
            <button class="custom-btn ribbon-btn" data-variant="gothic" title="Gothic">
                <div class="icon-box"><Scroll class="icon" /></div>
                <span class="label">Gothic</span>
            </button>
            <button class="custom-btn ribbon-btn" data-variant="doublestruck" title="Double">
                <div class="icon-box"><Type class="icon" /></div>
                <span class="label">Double</span>
            </button>
        </div>
    </div>

    <!-- Separator -->
    <div class="separator"></div>

    <!-- Actions Group -->
    <div class="ribbon-group">
        <span class="group-label" data-i18n="inlinked.actions_group">Acciones</span>
        <div class="group-content">
            <button class="format-btn ribbon-btn" data-format="clean" title="Limpiar" data-i18n-tooltip="inlinked.clean">
                <div class="icon-box"><Eraser class="icon" /></div>
                <span class="label" data-i18n="inlinked.clean">Limpiar</span>
            </button>
            
            <button id="clearBtn" class="ribbon-btn danger" title="Borrar Todo" data-i18n-tooltip="inlinked.clear">
                <div class="icon-box"><Trash2 class="icon" /></div>
                <span class="label" data-i18n="inlinked.clear">Borrar</span>
            </button>
            
            <button id="copyBtn" class="ribbon-btn primary" title="Copiar a LinkedIn" data-i18n-tooltip="inlinked.copy">
                <div class="icon-box" id="copyIconBox"><Copy class="icon" /></div>
                <span class="label" id="copyLabel" data-i18n="inlinked.copy">Copiar</span>
            </button>
        </div>
    </div>
  </div>

  <div class="editor-content-area">
      <div id="editor" data-i18n-placeholder="inlinked.placeholder"></div>
  </div>
  
  <div class="status-bar">
    <span id="charCount">0 caracteres</span>
  </div>
</div>

<style>
  .editor-wrapper {
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  .ribbon-toolbar {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: stretch;
    gap: 1.5rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; 
    min-height: 90px;
  }
  
  .ribbon-toolbar::-webkit-scrollbar {
      display: none;
  }

  .ribbon-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      min-width: max-content;
  }
  
  .group-label {
      font-size: 0.7rem;
      color: #94a3b8;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.05em;
      margin-bottom: 2px;
  }
  
  .group-content {
      display: flex;
      gap: 0.5rem;
      align-items: flex-start;
  }

  .separator {
      width: 1px;
      background: #cbd5e1;
      margin: 0.5rem 0;
      align-self: stretch;
  }

  /* Increased specificity to override Quill defaults */
  #toolbar .ribbon-btn {
      display: flex !important;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
      min-width: 60px;
      color: #475569;
      
      /* Reset Quill Overrides */
      height: auto !important;
      width: auto !important;
      float: none !important;
  }

  #toolbar .ribbon-btn:hover {
      background: #e2e8f0;
      color: #0f172a;
  }
  
  #toolbar .ribbon-btn.ql-active, #toolbar .ribbon-btn.active, #toolbar .ribbon-btn:active {
      background: #cbd5e1;
      color: #0f172a;
  }

  #toolbar .ribbon-btn.primary {
      color: #0f172a;
      background: #f1f5f9;
  }
  #toolbar .ribbon-btn.primary:hover {
      background: #e2e8f0;
  }
  
  #toolbar .ribbon-btn.danger:hover {
      background: #fee2e2;
      color: #ef4444;
  }

  #toolbar .icon-box {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
  }
  
  #toolbar .icon, #toolbar .icon-box svg {
      width: 24px;
      height: 24px;
      stroke-width: 2px;
      float: none !important; /* Override Quill float */
  }

  .label {
      font-size: 0.75rem;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
  }

  .editor-content-area {
      flex: 1;
      overflow-y: hidden;
      display: flex;
      flex-direction: column;
      background: white;
  }

  #editor {
    flex: 1;
    font-size: 1.15rem;
    font-family: 'Ubuntu', 'Segoe UI Symbol', 'Apple Symbols', 'Noto Sans Math', sans-serif; 
    border: none;
    overflow-y: auto;
    padding: 1rem;
  }

  .status-bar {
    padding: 0.5rem 1rem;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
    font-size: 0.75rem;
    color: #64748b;
    text-align: right;
  }
  
  /* Quill Overrides */
  .ql-toolbar.ql-snow {
      border: none !important;
      padding: 0 !important;
      font-family: inherit !important;
  }
  .ql-container.ql-snow {
      border: none !important;
  }
  
  /* Mobile adjustments */
  @media (max-width: 640px) {
      .ribbon-toolbar {
          gap: 0.5rem;
      }
      #toolbar .ribbon-btn {
          min-width: 44px;
          padding: 0.4rem;
      }
      .label {
          font-size: 0.65rem;
      }
  }
</style>

<script>
  import Quill from 'quill';
  import { deltaToUnicode } from '../../utils/deltaToUnicode';
  import { toUnicodeVariant } from '../../utils/toUnicodeVariant';
  import { unicodeToAscii } from '../../utils/unicodeToAscii';

  const charCount = document.getElementById('charCount');
  const copyBtn = document.getElementById('copyBtn');
  const copyLabel = document.getElementById('copyLabel');
  const copyIconBox = document.getElementById('copyIconBox');
  const clearBtn = document.getElementById('clearBtn');
  const customBtns = document.querySelectorAll('.custom-btn');
  const formatBtns = document.querySelectorAll('.format-btn');
  
  // Wait for localization
  const getT = (key, defaultText) => {
      if (window.Localization) {
          return window.Localization.t(key);
      }
      return defaultText;
  };

  // Initialize Quill
  const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: '#toolbar'
    },
    placeholder: 'Escribe aquí tu post para LinkedIn...' // Default, will be updated by localization
  });
  
  // Apply placeholder from localization if available or listener
  window.addEventListener('languageChanged', () => {
       const ph = window.Localization.t('inlinked.placeholder');
       quill.root.dataset.placeholder = ph;
  });
  // Initial check
  if (window.Localization) {
       quill.root.dataset.placeholder = window.Localization.t('inlinked.placeholder');
  }


  function updateCharCount() {
    const text = quill.getText();
    if (charCount) {
      const length = Math.max(0, text.length - 1);
      charCount.textContent = `${length} caracteres`;
    }
  }

  quill.on('text-change', updateCharCount);
  
  // Custom Format Handlers (LinkedIn Styles)
  customBtns.forEach(btn => {
      btn.addEventListener('click', () => {
          const variant = (btn as HTMLElement).dataset.variant;
          if (!variant) return;
          
          const range = quill.getSelection();
          if (range && range.length > 0) {
              const text = quill.getText(range.index, range.length);
              const converted = toUnicodeVariant(text, variant);
              
              quill.deleteText(range.index, range.length);
              quill.insertText(range.index, converted);
              quill.setSelection(range.index, converted.length);
          }
      });
  });

  // Standard Format Handlers & Clean
  formatBtns.forEach(btn => {
      btn.addEventListener('click', () => {
          const format = (btn as HTMLElement).dataset.format;
          if (!format) return;
          
          if (format === 'clean') {
               // Custom Clean Logic
               // Try to normalize Unicode first
               const range = quill.getSelection();
               if (range && range.length > 0) {
                   const text = quill.getText(range.index, range.length);
                   const normalized = unicodeToAscii(text);
                   if (text !== normalized) {
                       quill.deleteText(range.index, range.length);
                       quill.insertText(range.index, normalized);
                       quill.setSelection(range.index, normalized.length);
                   }
                   // Also remove standard formatting
                   quill.removeFormat(range.index, range.length);
               }
          } else {
             const currentFormats = quill.getFormat();
             quill.format(format, !currentFormats[format]);
          }
      });
  });

  // Update Active State on Selection Change
  quill.on('editor-change', (eventName, ...args) => {
      if (eventName === 'selection-change') {
          const range = args[0];
          if (range) {
              const formats = quill.getFormat(range);
              formatBtns.forEach(btn => {
                  const format = (btn as HTMLElement).dataset.format;
                  if (format && format !== 'clean') {
                      if (formats[format]) {
                          btn.classList.add('active');
                      } else {
                          btn.classList.remove('active');
                      }
                  }
              });
          }
      }
  });

  // Copy Functionality
  copyBtn?.addEventListener('click', async () => {
      const delta = quill.getContents();
      const unicodeText = deltaToUnicode(delta);
      
      try {
        await navigator.clipboard.writeText(unicodeText);
        
        // Visual Feedback
        if (copyLabel) copyLabel.textContent = getT('inlinked.copied', 'Copiado');
        if (copyBtn) copyBtn.classList.add('success');
        
        setTimeout(() => {
            if (copyLabel) copyLabel.textContent = getT('inlinked.copy', 'Copiar');
            if (copyBtn) copyBtn.classList.remove('success');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy', err);
        alert(getT('inlinked.error_copy', 'No se pudo copiar el texto.'));
      }
  });

  clearBtn?.addEventListener('click', () => {
      if (confirm(getT('inlinked.confirm_clear', '¿Borrar todo el texto?'))) {
          quill.setText('');
      }
  });
  
  // Update Copy Button Success Style dynamically
  const style = document.createElement('style');
  style.textContent = `
    #toolbar .ribbon-btn.success {
        color: #16a34a;
        background: #dcfce7;
    }
  `;
  document.head.appendChild(style);

  // Expose for external use if needed
  window.insertInVisualEditor = (text: string) => {
       const selection = quill.getSelection(true);
       quill.insertText(selection.index, text);
  };
</script>